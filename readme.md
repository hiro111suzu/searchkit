# 検索キット

作者: suzu

# 目次
- [検索キット](#検索キット)
- [概要](#概要)
- [用語](#用語)
- [インストール](#インストール)
	- [ファイル](#ファイル)
- [利用方法](#利用方法)
	- [基本](#基本)
	- [スクリプト引数の使い方の例](#スクリプト引数の使い方の例)
- [応用](#応用)
	- [タブ名とプレフィックス](#タブ名とプレフィックス)
	- [検索結果タブのパス](#検索結果タブのパス)
	- [タブのタイプによる動作](#タブのタイプによる動作)
	- [検索法の追加](#検索法の追加)
- [使用について](#使用について)


# 概要
* 秀丸ファイラーClassic（以下、秀丸ファイラー）でEverything検索や、Windowsインデックス検索の検索結果を扱うツールです。
	+ 秀丸ファイラーの多彩な機能で検索結果のファイル一覧を操作できます。
	+ タブとして保持できるので、検索結果がたくさんあっても持て余すことなくがなくなります。
* 秀丸ファイラー公式のスクリプトライブラリにある「Everythingで検索」と「Windows標準のインデックス検索で検索」をひとつにまとめて、機能追加したものです。
	+ 検索結果の更新や、キーワードの再編集・再検索ができるようにしました。
	+ 注目バーに検索ヒット数を出したり、タブの色分けのためにパス指定をするようにしています。
* 別の検索スクリプトを作るときのフレームワークになるようにしました。
	+ Everythingの別の条件、または他の検索ツール（例: WSL上のlocate）のような、別の検索ツールを作るときにこのスクリプトに付け足せるようにしています。
	+ 更新や再検索の機能、インターフェースを共有できます。

# 用語
* [Everything](https://www.voidtools.com/)
	+ 超高速検索ツールとして有名なフリーのソフトウェア
	+ ファイル内容まではインデックスされない代わりに、検索もインデックスの収集も極めて高速
* Windowsインデックス検索
	+ Windows標準の検索機能
	+ ファイルの中身やメタ情報までも対象とするインデックス検索
	+ スタートメニューなどで見る検索の動作からは愚鈍な印象しか受けないかもしれないが、単体で使うと結構高速でなかなか便利
	+ オフィス系のドキュメントファイルの検索に向いている
* カスタムファイルリスト
	+ 秀丸ファイラーの検索結果表示用のインターフェース
	+ バラバラの場所にあるフォルダー・ファイルが一つの一か所にあるかのような使用感で、ファイル操作が可能

# インストール
* 基本的にスクリプト *searchkit.js* をスクリプト登録するだけです
	+ 後述の「応用」を参考に、使いやすいように設定・改造してください
* Everythingが稼働していないと、Everything検索関係の機能は利用できません。

## ファイル

|ファイル名     |内容                                       |
|:--------------|:------------------------------------------|
|*searchkit.js* |スクリプト本体                             |
|*readme.html*  |この文書                                   |
|*es.exe*       |Everythingのコマンドラインインターフェース |
|*cli.c*        |*es.exeの* ソースファイルとライセンス文書  |


# 利用方法
## 基本
* スクリプト引数なしで、つまり普通に実行すると、デフォルト検索法（Everything）で検索するための入力ボックスが出現します。
	+ デフォルト検索法は、スクリプトを編集で簡単に他の検索法に変更できます。
* 第一引数に、以下のコマンドが指定できます。
	+ 「サンプル的」とは、実用性よりも、改造の参考になるような「例」として作られているという意味です。
	+ もちろん目的に合えば、そのまま利用してもOKです。

|コマンド       |内容                                                             |
|:--------------|:----------------------------------------------------------------|
|*es_search*    |Everything検索                                                   |
|*win_search*   |Windowsインデックス検索                                          |
|*refresh*      |検索結果のを更新（同じタブで、同じ条件で再検索する）             |
|*filter*       |検索語を再編集して再検索                                         |
|*es_subfolder* |現在のタブのサブフォルダーの中からEverything検索（サンプル的）   |
|*es_today*     |1日以内に変更したファイルからEverything検索（サンプル的）        |
|*refresh_plus* |タブのタイプによって「更新」の動作を切り替える例（サンプル的）   |
|*filter_plus*  |タブのタイプによって「再検索」の動作を切り替える例（サンプル的） |

* コマンド以外の文字列を受け取った場合は、その語句をデフォルト検索法で検索します。
* 第一引数がコマンドだった場合、第二引数が検索語とみなされます。
	+ 省略した場合、検索語の入力ボックスが出ます。

## スクリプト引数の使い方の例
* 秀丸ファイラーのブックマークやツールに登録
	+ ツールやブックマークの登録画面の「パス」の入力ボックスに、スクリプト名と任意のスクリプト引数を書き込みます。
		- スクリプト名のあとにスペース区切りで文字列を付け足すと、スクリプト引数になります。
		- ```"...\searchkit\searchkit.js" win_search```
	+ 引数付きでツール登録すれば、個別の機能や特定の検索語に、直接ショートカットキーやマウスジェスチャーを割り当てられるようになります。
* 別のスクリプトから呼び出し
	+ 例えば、拙作の「コマンドパレット」に登録すると、設定の同期も簡単で、色々柔軟に利用できて便利です。
		- コマンドパレットv1では、初期状態で登録済みです。
* AutoHotkeyなどの外部ツールから呼び出し
	+ 以下の例はEverything本体のウインドウで実行した検索の結果を、秀丸ファイラーのタブにするAutoHotkeyスクリプトです
		- 実際にはファイルパスの編集や、キーの割当など環境に応じた設定が必要です。

```AutoHotkey
#IfWinActive, ahk_class EVERYTHING
	^H::
		Send, ^f
		words := _copy_selected()
		Send, ^w
		_es_hidefile( words )
	return
return

_es_hidefile( words ) {
	Run, C:\program files\HmFilerClassic\HmFilerClassic.exe
		/x "%OneDriveConsumer%\config\hidefile\searchkit\searchkit.js"
		/a "es_search"
		/a "%words%"
}

_copy_selected(){
	prevcb=%clipboard%
	clipboard=
	Send, ^c
	ClipWait, 0.5
	cpbd=%clipboard%
	if ( cpbd == "" ) {
		clipboard=%prevcb%
		return %prevcb%
	} else {
		return cpbd
	}
} 
```

# 応用
## タブ名とプレフィックス
* 再検索や検索語の再編集のために、タブ名に検索法と検索語が書き込まれる仕組みです。
* 1文字目の"?"が、本スクリプト（検索キット）によるタブである印です。
	+ ちなみに関連スクリプトは以下のようなルール
		- 「クリップフォルダー」は一文字目が"*"（アスタリスク）
		- 「秀丸ヒストリ」はタブ名が"*秀丸ヒストリ"
* 各検索ツールにはプレフィックスが割り当てられています。
	+ *user_conf.prefix2func* オブジェクトで指定されている
* タブ名の最初の空白までがプレフィックス、それ以降が検索文字列となります。

## 検索結果タブのパス
* デフォルトでは、検索結果のパス名には、"c:\"が割り当てられるています。
	+ 変更するには、*user_conf.set_dir* オブジェクトの値を編集
* 検索フォルダー専用のフォルダーを作成すると便利です。
	+ 実際には使わない空のフォルダー
	+ 秀丸ファイラーの色設定でそのフォルダーのタブの色等を指定すると、検索タブと通常タブの見分けが付きやすくなって便利になる
	+ フォルダパスを"C:\$"などにすると、「タブのソート」スクリプトでタブを整列させたときに、ウインドウの左側に検索タブが集まるので便利

## タブのタイプによる動作
* 通常タブでは通常の「更新」、検索結果タブでは「再検索」のような機能があると便利になります。
* 以下の設定で、通常のタブと検索結果タブをシームレスに扱えるようになります。
	+ コマンドの *filter_plus* と *refresh_plus* がそういった操作のためのスクリプトの例
	+ これらを好みに改造すし、"filter_plus"や"refresh_plus" の引数付きのスクリプト登録
	+ Ctrl+RやCtrl+Fなど、日常的に押すキーに割り当てる

## 検索法の追加
* 新しく検索法を作る場合に必要な点は以下の2つです。
	+ グローバルに関数を作成
		- スクリプト本体のグローバルにある関数は、すべて「コマンド」になる
	+ *user_conf.prefix2func* オブジェクトに検索のプレフィックスと検索関数名を登録
* 更新（再検索）や、検索語の再編集などのコマンドが、その検索法でも使えるようになります。

# 使用について
* 同梱の *es.exe* については、そのソースファイル *cli.c* 内にライセンス文が記述されています。
* それ以外の文書とスクリプトについて、複製、改造、再配布に制限はありません。
* 無保証です。
